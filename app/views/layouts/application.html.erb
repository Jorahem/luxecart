<!DOCTYPE html>
<html class="h-full bg-gray-50">
  <head>
    <title>LuxeCart | Premium E-Commerce</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- FAVICONS / PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/favicons/android-chrome-512x512.png">
    <link rel="manifest" href="/favicons/manifest.json">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="theme-color" content="#4f46e5">

    <!-- Tailwind CDN (development-friendly) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js for responsive hamburger menu -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.7/dist/cdn.min.js" defer></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Rails Assets -->
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <body class="min-h-screen flex flex-col">

    <!-- Turbo permanent overlay (for loaders / modals if needed) -->
    <div class="page-overlay" aria-hidden="true" data-turbo-permanent></div>

    <!-- Flash Messages -->
    <%= render "shared/flash" %>

    <!-- NAVBAR (Turbo-permanent to avoid reload flicker, now responsive) -->
    <nav x-data="{ open: false }" class="bg-white shadow-sm border-b sticky top-0 z-50" data-turbo-permanent>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16 items-center">

          <!-- Brand -->
          <div class="flex items-center gap-8">
            <%= link_to root_path, class: "text-2xl font-bold text-indigo-600 tracking-tight" do %>
              LUXE<span class="text-gray-900">CART</span>
            <% end %>
          </div>

          <!-- Hamburger button for mobile -->
          <button 
            @click="open = !open"
            class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500 md:hidden"
            aria-controls="mobile-menu"
            aria-expanded="false"
          >
            <span class="sr-only">Open main menu</span>
            <svg class="h-6 w-6" x-show="!open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            <svg class="h-6 w-6" x-show="open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>

          <!-- Nav Links - Desktop Only -->
          <div class="hidden md:flex items-center space-x-4">
            <%= link_to "Home", root_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to "Products", products_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to "Categories", categories_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to "About", about_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to cart_path, class: "text-gray-600 hover:text-indigo-600 font-medium inline-flex items-center gap-2" do %>
              <i class="fa-solid fa-cart-shopping"></i>
              <span class="hidden sm:inline">Cart</span>
              <span id="cart-count"
                    class="ml-1 inline-flex items-center justify-center bg-indigo-600 text-white rounded-full px-2 py-0.5 text-xs">
                <%= (session[:cart]&.values&.map(&:to_i)&.sum) || 0 %>
              </span>
            <% end %>
            <% if respond_to?(:user_signed_in?) && user_signed_in? %>
              <%= button_to destroy_user_session_path,
                    method: :delete,
                    form: { class: "inline" },
                    class: "text-gray-600 hover:text-indigo-600",
                    data: { confirm: "Are you sure you want to sign out?" } do %>
                Logout
              <% end %>
            <% else %>
              <%= link_to "Login", new_user_session_path, class: "text-gray-600 hover:text-indigo-600" %>
            <% end %>
          </div>
        </div>
      </div>
      <!-- Mobile menu dropdown -->
      <div class="md:hidden" id="mobile-menu" x-show="open" x-transition>
        <div class="px-2 pt-2 pb-3 space-y-1">
          <%= link_to "Home", root_path, class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium" %>
          <%= link_to "Products", products_path, class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium" %>
          <%= link_to "Categories", categories_path, class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium" %>
          <%= link_to "About", about_path, class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium" %>
          <%= link_to cart_path, class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium inline-flex items-center gap-2" do %>
            <i class="fa-solid fa-cart-shopping"></i>
            <span>Cart</span>
            <span id="cart-count-mobile"
                  class="ml-1 inline-flex items-center justify-center bg-indigo-600 text-white rounded-full px-2 py-0.5 text-xs">
              <%= (session[:cart]&.values&.map(&:to_i)&.sum) || 0 %>
            </span>
          <% end %>
          <% if respond_to?(:user_signed_in?) && user_signed_in? %>
            <%= button_to destroy_user_session_path,
                  method: :delete,
                  form: { class: "inline" },
                  class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium",
                  data: { confirm: "Are you sure you want to sign out?" } do %>
              Logout
            <% end %>
          <% else %>
            <%= link_to "Login", new_user_session_path, class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium" %>
          <% end %>
        </div>
      </div>
    </nav>

    <!-- PAGE CONTENT -->
    <main class="flex-grow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <%= yield %>
      </div>
    </main>

    <!-- FOOTER -->
    <%= render "shared/footer" %>

    <!-- ADD TO CART AJAX (Turbo-safe) -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const csrf = document.querySelector('meta[name="csrf-token"]')?.content;

        const cartBadge = document.getElementById('cart-count');
        const cartBadgeMobile = document.getElementById('cart-count-mobile');

        function setCartCount(count) {
          if (cartBadge) cartBadge.textContent = count;
          if (cartBadgeMobile) cartBadgeMobile.textContent = count;
        }

        function redirectToLogin() {
          const current = window.location.pathname + window.location.search;
          window.location.href = `/users/sign_in?redirect=${encodeURIComponent(current)}`;
        }

        async function addToCart(url, productId) {
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'X-CSRF-Token': csrf,
              'Accept': 'application/json',
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            credentials: 'same-origin',
            body: new URLSearchParams({ product_id: productId })
          });

          const contentType = res.headers.get('content-type') || '';

          if (!res.ok && (res.status === 401 || contentType.includes('text/html'))) {
            alert('First you have to login');
            redirectToLogin();
            return;
          }

          if (res.ok && contentType.includes('application/json')) {
            const data = await res.json();
            if (data.cart_count !== undefined) {
              setCartCount(data.cart_count);
              cartBadge?.classList.add('ring', 'ring-indigo-300');
              cartBadgeMobile?.classList.add('ring', 'ring-indigo-300');
              setTimeout(() => {
                cartBadge?.classList.remove('ring', 'ring-indigo-300');
                cartBadgeMobile?.classList.remove('ring', 'ring-indigo-300');
              }, 700);
            }
          }
        }

        document.querySelectorAll('.add-to-cart-ajax').forEach(btn => {
          btn.addEventListener('click', e => {
            e.preventDefault();
            addToCart(btn.dataset.url || '/cart/add_item', btn.dataset.productId);
          });
        });
      });
    </script>

  </body>
</html>