<!DOCTYPE html>
<html class="h-full bg-gray-50">
  <head>
    <title>LuxeCart | Premium E-Commerce</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- FAVICONS / PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/favicons/android-chrome-512x512.png">
    <link rel="manifest" href="/favicons/manifest.json">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="theme-color" content="#4f46e5">

    <!-- Tailwind CDN (development-friendly) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js for responsive hamburger menu -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.7/dist/cdn.min.js" defer></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Rails Assets -->
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>

    <!-- Make sure currentUserLoggedIn is globally available BEFORE any other JS  -->
    <script>
      window.currentUserLoggedIn = <%= !!current_user ? 'true' : 'false' %>;
    </script>
  </head>

  <body class="min-h-screen flex flex-col">

    <!-- Turbo permanent overlay (for loaders / modals if needed) -->
    <div class="page-overlay" aria-hidden="true" data-turbo-permanent></div>

    <!-- Flash Messages -->
    <%= render "shared/flash" %>

    <!-- NAVBAR (Turbo-permanent) -->
    <nav x-data="{ open: false }" class="bg-white shadow-sm border-b sticky top-0 z-50" data-turbo-permanent>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16 items-center">

          <!-- Brand -->
          <div class="flex items-center gap-8">
            <%= link_to root_path, class: "text-2xl font-bold text-indigo-600 tracking-tight" do %>
              LUXE<span class="text-gray-900">CART</span>
            <% end %>
          </div>

          <!-- Hamburger button for mobile -->
          <button 
            @click="open = !open"
            class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500 md:hidden"
            aria-controls="mobile-menu"
            aria-expanded="false"
          >
            <span class="sr-only">Open main menu</span>
            <svg class="h-6 w-6" x-show="!open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            <svg class="h-6 w-6" x-show="open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>

          <!-- Nav Links - Desktop Only -->
          <div class="hidden md:flex items-center space-x-4">
            <%= link_to "Home", root_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to "Products", products_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to "Categories", categories_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to "About", about_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to cart_path, class: "text-gray-600 hover:text-indigo-600 font-medium inline-flex items-center gap-2" do %>
              <i class="fa-solid fa-cart-shopping"></i>
              <span class="hidden sm:inline">Cart</span>
              <span id="cart-count"
                    class="ml-1 inline-flex items-center justify-center bg-indigo-600 text-white rounded-full px-2 py-0.5 text-xs">
                <%= (session[:cart]&.values&.map(&:to_i)&.sum) || 0 %>
              </span>
            <% end %>
            <% if respond_to?(:user_signed_in?) && user_signed_in? %>
                <!-- Avatar Profile Link (Desktop) -->
                <%= link_to profile_path, class: "relative flex items-center group ml-2" do %>
                  <% if current_user.profile_image.attached? %>
                    <%= image_tag current_user.profile_image.variant(resize_to_fill: [32, 32]), alt: "Profile", class: "w-8 h-8 rounded-full object-cover border-2 border-indigo-600 group-hover:scale-110 transition" %>
                  <% else %>
                    <span class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-500 border-2 border-indigo-600 group-hover:scale-110 transition">
                      <i class="fa fa-user text-lg"></i>
                    </span>
                  <% end %>
                  <span class="sr-only">Profile</span>
                <% end %>
                <!-- Updated Logout Button triggers modal -->
                <a href="#" id="show-logout-modal" class="text-gray-600 hover:text-indigo-600 ml-2">Logout</a>
            <% else %>
              <%= link_to "Login", new_user_session_path, class: "text-gray-600 hover:text-indigo-600" %>
            <% end %>
          </div>
        </div>
      </div>
      <!-- Mobile menu dropdown -->
      <div class="md:hidden" id="mobile-menu" x-show="open" x-transition>
        <div class="px-2 pt-2 pb-3 space-y-1">
          <%= link_to "Home", root_path, class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium" %>
          <%= link_to "Products", products_path, class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium" %>
          <%= link_to "Categories", categories_path, class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium" %>
          <%= link_to "About", about_path, class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium" %>
          <%= link_to cart_path, class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium inline-flex items-center gap-2" do %>
            <i class="fa-solid fa-cart-shopping"></i>
            <span>Cart</span>
            <span id="cart-count-mobile"
                  class="ml-1 inline-flex items-center justify-center bg-indigo-600 text-white rounded-full px-2 py-0.5 text-xs">
              <%= (session[:cart]&.values&.map(&:to_i)&.sum) || 0 %>
            </span>
          <% end %>
          <% if respond_to?(:user_signed_in?) && user_signed_in? %>
            <!-- Avatar Profile Link (Mobile) -->
            <%= link_to profile_path, class: "inline-flex items-center gap-2 px-3 py-2 font-medium rounded-lg hover:bg-indigo-100" do %>
              <% if current_user.profile_image.attached? %>
                <%= image_tag current_user.profile_image.variant(resize_to_fill: [32, 32]), alt: "Profile", class: "w-8 h-8 rounded-full object-cover border-2 border-indigo-600" %>
              <% else %>
                <span class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-500 border-2 border-indigo-600">
                  <i class="fa fa-user text-lg"></i>
                </span>
              <% end %>
              <span>Profile</span>
            <% end %>
            <!-- Updated Logout Button triggers modal -->
            <a href="#" id="show-logout-modal-mobile" class="block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium">Logout</a>
          <% else %>
            <%= link_to "Login", new_user_session_path, class: "block text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg px-3 py-2 font-medium" %>
          <% end %>
        </div>
      </div>
    </nav>

    <!-- Logout Confirmation Modal -->
    <div id="logout-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white p-6 rounded-lg shadow-lg text-center max-w-xs w-full">
        <div class="mb-4 text-lg font-semibold text-gray-800">Are you sure you want to logout?</div>
        <div class="flex justify-center gap-6 mt-4">
          <form id="logout-form" method="post" action="<%= destroy_user_session_path %>">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <input type="hidden" name="_method" value="delete" />
            <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Yes</button>
          </form>
          <button id="cancel-logout" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">No</button>
        </div>
      </div>
    </div>

    <!-- PAGE CONTENT -->
    <main class="flex-grow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <%= yield %>
      </div>
    </main>

    <!-- FOOTER -->
    <%= render "shared/footer" %>

    <!-- ADD TO CART AJAX (Turbo-safe) -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const csrf = document.querySelector('meta[name="csrf-token"]')?.content;

      const cartBadge = document.getElementById('cart-count');
      const cartBadgeMobile = document.getElementById('cart-count-mobile');

      function setCartCount(count) {
        if (cartBadge) cartBadge.textContent = count;
        if (cartBadgeMobile) cartBadgeMobile.textContent = count;
      }

      function redirectToLogin() {
        const current = window.location.pathname + window.location.search;
        window.location.href = `/users/sign_in?redirect=${encodeURIComponent(current)}`;
      }

      async function addToCart(url, productId) {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRF-Token': csrf,
            'Accept': 'application/json',
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          credentials: 'same-origin',
          body: new URLSearchParams({ product_id: productId })
        });

        const contentType = res.headers.get('content-type') || '';

        if (!res.ok && (res.status === 401 || contentType.includes('text/html'))) {
          alert('First you have to login');
          redirectToLogin();
          return;
        }

        if (res.ok && contentType.includes('application/json')) {
          const data = await res.json();
          if (data.cart_count !== undefined) {
            setCartCount(data.cart_count);
            cartBadge?.classList.add('ring', 'ring-indigo-300');
            cartBadgeMobile?.classList.add('ring', 'ring-indigo-300');
            setTimeout(() => {
              cartBadge?.classList.remove('ring', 'ring-indigo-300');
              cartBadgeMobile?.classList.remove('ring', 'ring-indigo-300');
            }, 700);
          }
        }
      }

      document.querySelectorAll('.add-to-cart-ajax').forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          if (typeof window.currentUserLoggedIn !== "undefined" && !window.currentUserLoggedIn) {
            alert('First you have to login');
            redirectToLogin();
            return;
          }
          addToCart(btn.dataset.url || '/cart/add_item', btn.dataset.productId);
        });
      });
    });
    </script>

    <!-- Logout Modal JS -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      function showModal() {
        document.getElementById('logout-modal').classList.remove('hidden');
      }
      function hideModal() {
        document.getElementById('logout-modal').classList.add('hidden');
      }
      let showLogout = document.getElementById('show-logout-modal');
      let showLogoutMobile = document.getElementById('show-logout-modal-mobile');
      let cancelBtn = document.getElementById('cancel-logout');
      if (showLogout) showLogout.addEventListener('click', function(e) { e.preventDefault(); showModal(); });
      if (showLogoutMobile) showLogoutMobile.addEventListener('click', function(e) { e.preventDefault(); showModal(); });
      if (cancelBtn) cancelBtn.addEventListener('click', function(e) { e.preventDefault(); hideModal(); });
      document.addEventListener('keydown', function(e) {
        if (e.key === "Escape") hideModal();
      });
    });
    </script>

  </body>
</html>