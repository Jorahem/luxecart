<!DOCTYPE html>
<html class="h-full bg-gray-50">
  <head>
    <title>LuxeCart | Premium E-Commerce</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- FAVICONS / PWA META -->
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="manifest" href="/favicons/manifest.json">
    <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="#2d89ef">
    <meta name="msapplication-config" content="/favicons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <!-- Tailwind (CDN) - OK for development -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- main compiled CSS from the asset pipeline -->
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>

    <!-- application JS (include unconditionally so Turbo / Rails UJS can run) -->
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <!-- min-h-screen ensures footer is pushed to bottom when content is short -->
  <body class="min-h-screen flex flex-col">
    <%= render "shared/flash" %>

    <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16 items-center">
          <div class="flex items-center gap-8">
            <%= link_to root_path, class: "text-2xl font-bold text-indigo-600 tracking-tight" do %>
              LUXE<span class="text-gray-900">CART</span>
            <% end %>
          </div>

          <div class="flex items-center space-x-4">
            <%= link_to "Home", root_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to "Products", products_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to "Categories", categories_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to "About", about_path, class: "text-gray-600 hover:text-indigo-600" %>

            <%# Cart link with live badge (reads session for initial value) %>
            <%= link_to cart_path, class: "text-gray-600 hover:text-indigo-600 font-medium inline-flex items-center gap-2" do %>
              <i class="fa-solid fa-cart-shopping"></i>
              <span class="hidden sm:inline">Cart</span>
              <span id="cart-count" class="ml-1 inline-flex items-center justify-center bg-indigo-600 text-white rounded-full px-2 py-0.5 text-xs">
                <%= (session[:cart]&.values&.map(&:to_i)&.sum) || 0 %>
              </span>
            <% end %>

            <% if respond_to?(:user_signed_in?) && user_signed_in? %>
              <%= button_to destroy_user_session_path,
                    method: :delete,
                    form: { class: "inline" },
                    class: "text-gray-600 hover:text-indigo-600 focus:outline-none",
                    data: { confirm: "Are you sure you want to sign out?" } do %>
                Logout
              <% end %>
            <% else %>
              <%= link_to "Login", new_user_session_path, class: "text-gray-600 hover:text-indigo-600" %>
            <% end %>
          </div>
        </div>
      </div>
    </nav>

    <!-- Page content container -->
    <main class="flex-grow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <%= yield %>
      </div>
    </main>

    <!-- Responsive footer partial -->
    <%= render "shared/footer" %>

    <!-- Add-to-Cart script (site-wide). Posts to /cart/add_item and updates the badge #cart-count -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
      const csrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

      function setCartCount(count) {
        const el = document.getElementById('cart-count');
        if (!el) return;
        el.textContent = count;
      }

      function incrementCartCount(by = 1) {
        const el = document.getElementById('cart-count');
        if (!el) return;
        const current = parseInt(el.textContent || '0', 10);
        setCartCount(current + by);
      }

      async function postAddToCart(url, productId) {
        try {
          const body = new URLSearchParams({ product_id: productId }).toString();

          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'X-CSRF-Token': csrf,
              'Accept': 'application/json',
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            credentials: 'same-origin',
            body: body
          });

          console.debug('POST', url, 'product_id=', productId, 'status=', res.status);

          const ct = res.headers.get('content-type') || '';
          if (res.ok && ct.indexOf('application/json') !== -1) {
            const data = await res.json();
            console.debug('Add-to-cart response JSON:', data);
            if (data && typeof data.cart_count !== 'undefined') {
              setCartCount(data.cart_count);
              return { success: true, data };
            }
          }

          if (res.ok) {
            incrementCartCount(1);
            return { success: true };
          }

          const text = await res.text();
          console.warn('Add-to-cart non-ok response:', res.status, text);
          return { success: false, status: res.status, text };
        } catch (err) {
          console.error('Add-to-cart fetch error', err);
          return { success: false, error: err };
        }
      }

      document.querySelectorAll('.add-to-cart-ajax').forEach(btn => {
        btn.addEventListener('click', async function (e) {
          e.preventDefault();
          const url = btn.dataset.url || '/cart/add_item';
          const pid = btn.dataset.productId || btn.dataset.product_id;
          if (!pid) return console.warn('Missing data-product-id on add button');

          btn.disabled = true;
          btn.classList.add('opacity-70', 'cursor-wait');

          const result = await postAddToCart(url, pid);

          btn.disabled = false;
          btn.classList.remove('opacity-70', 'cursor-wait');

          if (!result.success) {
            alert('Could not add to cart. Please check your network or server logs.');
          } else {
            const badge = document.getElementById('cart-count');
            if (badge) {
              badge.classList.add('ring', 'ring-indigo-300');
              setTimeout(() => badge.classList.remove('ring', 'ring-indigo-300'), 700);
            }
          }
        });
      });
    });
    </script>
  </body>
</html>