<!DOCTYPE html>
<html class="h-full bg-gray-50">
  <head>
    <title>LuxeCart | Premium E-Commerce</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- FAVICONS / PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/favicons/android-chrome-512x512.png">
    <link rel="manifest" href="/favicons/manifest.json">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="theme-color" content="#4f46e5">

    <!-- Tailwind CDN (development-friendly) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Rails Assets -->
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <body class="min-h-screen flex flex-col">

    <!-- Turbo permanent overlay (for loaders / modals if needed) -->
    <div class="page-overlay" aria-hidden="true" data-turbo-permanent></div>

    <!-- Flash Messages -->
    <%= render "shared/flash" %>

    <!-- NAVBAR (Turbo-permanent to avoid reload flicker) -->
    <nav class="bg-white shadow-sm border-b sticky top-0 z-50" data-turbo-permanent>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16 items-center">

          <!-- Brand -->
          <div class="flex items-center gap-8">
            <%= link_to root_path, class: "text-2xl font-bold text-indigo-600 tracking-tight" do %>
              LUXE<span class="text-gray-900">CART</span>
            <% end %>
          </div>

          <!-- Nav Links -->
          <div class="flex items-center space-x-4">
            <%= link_to "Home", root_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to "Products", products_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to "Categories", categories_path, class: "text-gray-600 hover:text-indigo-600" %>
            <%= link_to "About", about_path, class: "text-gray-600 hover:text-indigo-600" %>

            <!-- Cart -->
            <%= link_to cart_path, class: "text-gray-600 hover:text-indigo-600 font-medium inline-flex items-center gap-2" do %>
              <i class="fa-solid fa-cart-shopping"></i>
              <span class="hidden sm:inline">Cart</span>
              <span id="cart-count"
                    class="ml-1 inline-flex items-center justify-center bg-indigo-600 text-white rounded-full px-2 py-0.5 text-xs">
                <%= (session[:cart]&.values&.map(&:to_i)&.sum) || 0 %>
              </span>
            <% end %>

            <!-- Auth -->
            <% if respond_to?(:user_signed_in?) && user_signed_in? %>
              <%= button_to destroy_user_session_path,
                    method: :delete,
                    form: { class: "inline" },
                    class: "text-gray-600 hover:text-indigo-600",
                    data: { confirm: "Are you sure you want to sign out?" } do %>
                Logout
              <% end %>
            <% else %>
              <%= link_to "Login", new_user_session_path, class: "text-gray-600 hover:text-indigo-600" %>
            <% end %>
          </div>

        </div>
      </div>
    </nav>

    <!-- PAGE CONTENT -->
    <main class="flex-grow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <%= yield %>
      </div>
    </main>

    <!-- FOOTER -->
    <%= render "shared/footer" %>

    <!-- ADD TO CART AJAX (Turbo-safe) -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const csrf = document.querySelector('meta[name="csrf-token"]')?.content;

        const cartBadge = document.getElementById('cart-count');

        function setCartCount(count) {
          if (cartBadge) cartBadge.textContent = count;
        }

        function redirectToLogin() {
          const current = window.location.pathname + window.location.search;
          window.location.href = `/users/sign_in?redirect=${encodeURIComponent(current)}`;
        }

        async function addToCart(url, productId) {
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'X-CSRF-Token': csrf,
              'Accept': 'application/json',
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            credentials: 'same-origin',
            body: new URLSearchParams({ product_id: productId })
          });

          const contentType = res.headers.get('content-type') || '';

          if (!res.ok && (res.status === 401 || contentType.includes('text/html'))) {
            alert('First you have to login');
            redirectToLogin();
            return;
          }

          if (res.ok && contentType.includes('application/json')) {
            const data = await res.json();
            if (data.cart_count !== undefined) {
              setCartCount(data.cart_count);
              cartBadge?.classList.add('ring', 'ring-indigo-300');
              setTimeout(() => cartBadge?.classList.remove('ring', 'ring-indigo-300'), 700);
            }
          }
        }

        document.querySelectorAll('.add-to-cart-ajax').forEach(btn => {
          btn.addEventListener('click', e => {
            e.preventDefault();
            addToCart(btn.dataset.url || '/cart/add_item', btn.dataset.productId);
          });
        });
      });
    </script>

  </body>
</html>
