<%# Dedicated Men category page with extra product images and Add buttons %>
<%# Saves to: app/views/categories/men.html.erb %>

<%# --- Helpers --- %>
<% def safe_attached?(obj)
     return false unless obj.respond_to?(:attached?)
     begin
       obj.attached?
     rescue StandardError
       false
     end
   end

   def image_for(obj)
     return nil if obj.nil?
     if safe_attached?(obj)
       begin
         url_for(obj)
       rescue StandardError
         nil
       end
     else
       s = obj.to_s
       s.present? ? s : nil
     end
   end
%>

<%#
  Prepare a set of display_slots for the Men page.
  For each slot we'll try (in order):
   - Use a real product from @category.products (if present)
   - Otherwise use a placeholder image + label and (optionally) a fallback product id to make Add active
%>
<% placeholder_items = [
  { name: "Classic Denim Jacket", image: "https://images.unsplash.com/photo-1512436991641-6745cdb1723f?q=80&w=800&auto=format&fit=crop", price: 79.99 },
  { name: "Casual Chambray Shirt", image: "https://images.unsplash.com/photo-1503341455253-b2e723bb3dbb?q=80&w=800&auto=format&fit=crop", price: 39.50 },
  { name: "Slim Fit Chinos", image: "https://images.unsplash.com/photo-1541099649105-f69ad21f3246?q=80&w=800&auto=format&fit=crop", price: 49.00 },
  { name: "Striped Polo Tee", image: "https://images.unsplash.com/photo-1519741491592-8f28b8c7d8e7?q=80&w=800&auto=format&fit=crop", price: 24.99 },
  { name: "Leather Sneakers", image: "https://images.unsplash.com/photo-1528701800489-47614b3a1e2b?q=80&w=800&auto=format&fit=crop", price: 89.00 },
  { name: "Wool Overcoat", image: "https://images.unsplash.com/photo-1541099649105-3f8a3b2a8efb?q=80&w=800&auto=format&fit=crop", price: 129.00 }
] %>

<%# Build slots: prefer real products from @category.products, else placeholder. %>
<% display_slots = [] %>
<% real_products = (@category.products.active.limit(6).to_a rescue []) %>

<% 6.times do |i| %>
  <% if real_products[i] %>
    <% display_slots << { product: real_products[i] } %>
  <% else %>
    <% ph = placeholder_items[i % placeholder_items.length] %>
    <% display_slots << { placeholder: ph } %>
  <% end %>
<% end %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <!-- Breadcrumb + Cart badge -->
  <div class="flex items-center justify-between mb-6">
    <nav class="text-sm text-gray-500" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2">
        <li><%= link_to "Home", root_path, class: "hover:underline" %></li>
        <li>/</li>
        <li><%= link_to "Categories", categories_path, class: "hover:underline" %></li>
        <li>/</li>
        <li class="text-gray-900 font-semibold"><%= @category.name %></li>
      </ol>
    </nav>

    <div>
      <a href="/cart" class="inline-flex items-center gap-2 text-sm text-gray-700 hover:text-gray-900">
        <i class="fa-solid fa-cart-shopping"></i>
        <span id="cart-count" class="inline-flex items-center justify-center bg-indigo-600 text-white rounded-full px-2 py-0.5 text-xs">
          <%= (session[:cart]&.values&.map(&:to_i)&.sum) || 0 %>
        </span>
      </a>
    </div>
  </div>

  <!-- Men hero -->
  <div class="bg-gradient-to-r from-white to-gray-50 rounded-2xl p-6 mb-8 flex flex-col md:flex-row items-center gap-6">
    <div class="flex-1">
      <h1 class="text-3xl font-extrabold text-gray-900 mb-2"><%= @category.name %></h1>
      <% if @category.description.present? %>
        <p class="text-gray-600 mb-4"><%= @category.description %></p>
      <% else %>
        <p class="text-gray-600 mb-4">Shop men’s clothing — jackets, shirts, trousers, shoes and accessories.</p>
      <% end %>
      <div class="flex gap-3">
        <%= link_to "Shop all", category_path(@category), class: "inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md shadow-sm hover:bg-indigo-700" %>
      </div>
    </div>

    <div class="w-full md:w-1/3">
      <%# Optional hero image: render if category has one %>
      <% if @category.respond_to?(:image) && @category.image.present? %>
        <%= image_tag image_for(@category.image) || @category.image, alt: @category.name, class: "w-full h-40 object-cover rounded-xl shadow-sm" %>
      <% elsif @category.respond_to?(:image_url) && @category.image_url.present? %>
        <%= image_tag @category.image_url, alt: @category.name, class: "w-full h-40 object-cover rounded-xl shadow-sm" %>
      <% end %>
    </div>
  </div>

  <!-- Men products grid (6 slots with images + Add buttons) -->
  <section class="bg-white p-4 rounded-2xl shadow-sm mb-8">
    <h2 class="text-xl font-semibold mb-4">Popular Men Picks</h2>

    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
      <% display_slots.each do |slot| %>
        <% if slot[:product] %>
          <% p = slot[:product] %>
          <% img_src = nil
             if p.respond_to?(:product_images) && p.product_images.any?
               img_src ||= image_for(p.product_images.first.image) rescue nil
               img_src ||= (p.product_images.first.respond_to?(:image_url) ? p.product_images.first.image_url : nil) rescue nil
             end
             img_src ||= (p.respond_to?(:image_url) ? p.image_url : nil) rescue nil
             img_src ||= image_for(p.image) if p.respond_to?(:image)
          %>

          <div class="border rounded-lg p-4 flex flex-col">
            <%= link_to product_path(p) do %>
              <img src="<%= img_src || 'https://via.placeholder.com/400x300?text=No+Image' %>" class="w-full h-44 object-cover rounded-md mb-3" alt="<%= p.name %>">
            <% end %>

            <div class="flex-1">
              <div class="font-semibold text-sm mb-1"><%= link_to p.name, product_path(p), class: "hover:underline" %></div>
              <div class="text-gray-600 mb-2"><%= number_to_currency(p.price) if p.respond_to?(:price) %></div>
            </div>

            <div>
              <button type="button"
                      class="add-to-cart-ajax w-full inline-flex items-center justify-center px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm"
                      data-url="/cart/add_item"
                      data-product-id="<%= p.id %>">
                <i class="fa-solid fa-cart-plus mr-2"></i> Add
              </button>
            </div>
          </div>

        <% else %>
          <% ph = slot[:placeholder] %>
          <%# choose a fallback product id so button can work even for placeholders (if there is at least one product in the DB) %>
          <% fallback_product = Product.first rescue nil %>
          <% fallback_id = fallback_product&.id %>

          <div class="border rounded-lg p-4 flex flex-col">
            <img src="<%= ph[:image] %>" class="w-full h-44 object-cover rounded-md mb-3" alt="<%= ph[:name] %>">
            <div class="flex-1">
              <div class="font-semibold text-sm mb-1"><%= ph[:name] %></div>
              <div class="text-gray-600 mb-2"><%= number_to_currency(ph[:price]) %></div>
            </div>

            <div>
              <% if fallback_id.present? %>
                <button type="button"
                        class="add-to-cart-ajax w-full inline-flex items-center justify-center px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm"
                        data-url="/cart/add_item"
                        data-product-id="<%= fallback_id %>">
                  <i class="fa-solid fa-cart-plus mr-2"></i> Add
                </button>
              <% else %>
                <button disabled class="w-full inline-flex items-center justify-center px-3 py-2 bg-gray-200 text-gray-600 rounded-md text-sm cursor-not-allowed">Add</button>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </section>

  <!-- Optional larger grid of men clothing (shows @category.products if present) -->
  <section class="bg-white p-4 rounded-2xl shadow-sm">
    <h2 class="text-xl font-semibold mb-4">All Men Products</h2>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <% (@category.products.active.limit(12) rescue []).each do |p| %>
        <% img_src = nil
           if p.respond_to?(:product_images) && p.product_images.any?
             img_src ||= image_for(p.product_images.first.image) rescue nil
           end
           img_src ||= (p.respond_to?(:image_url) ? p.image_url : nil)
           img_src ||= image_for(p.image) if p.respond_to?(:image)
        %>

        <div class="rounded-lg border p-3 bg-white flex flex-col">
          <%= link_to product_path(p) do %>
            <img src="<%= img_src || 'https://via.placeholder.com/400x300?text=No+Image' %>" class="w-full h-40 object-cover rounded mb-3" alt="<%= p.name %>">
          <% end %>

          <div class="font-semibold"><%= link_to p.name, product_path(p) %></div>
          <div class="text-gray-600"><%= number_to_currency(p.price) if p.respond_to?(:price) %></div>

          <div class="mt-2">
            <button type="button"
                    class="add-to-cart-ajax inline-flex items-center px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm"
                    data-url="/cart/add_item"
                    data-product-id="<%= p.id %>">
              <i class="fa-solid fa-cart-plus mr-2"></i> Add
            </button>
          </div>
        </div>
      <% end %>
    </div>
  </section>
</div>

<!-- AJAX Add-to-Cart JS -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const csrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

  function setCartCount(count) {
    const el = document.getElementById('cart-count');
    if (!el) return;
    el.textContent = count;
  }

  function incrementCartCount(by = 1) {
    const el = document.getElementById('cart-count');
    if (!el) return;
    const current = parseInt(el.textContent || '0', 10);
    setCartCount(current + by);
  }

  async function postAddToCart(url, productId) {
    try {
      const body = new URLSearchParams({ product_id: productId }).toString();
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRF-Token': csrf,
          'Accept': 'application/json',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        credentials: 'same-origin',
        body: body
      });

      const ct = res.headers.get('content-type') || '';
      if (res.ok && ct.indexOf('application/json') !== -1) {
        const data = await res.json();
        if (data && typeof data.cart_count !== 'undefined') {
          setCartCount(data.cart_count);
          return { success: true };
        }
      }

      if (res.ok) {
        incrementCartCount(1);
        return { success: true };
      }

      return { success: false, status: res.status };
    } catch (err) {
      console.error('Add-to-cart error', err);
      return { success: false, error: err };
    }
  }

  document.querySelectorAll('.add-to-cart-ajax').forEach(btn => {
    btn.addEventListener('click', async function (e) {
      e.preventDefault();
      const url = btn.dataset.url;
      const pid = btn.dataset.productId;
      if (!url || !pid) return;

      btn.disabled = true;
      btn.classList.add('opacity-70', 'cursor-wait');

      const result = await postAddToCart(url, pid);

      btn.disabled = false;
      btn.classList.remove('opacity-70', 'cursor-wait');

      if (!result.success) {
        alert('Could not add to cart. Please try again.');
      } else {
        const badge = document.getElementById('cart-count');
        if (badge) {
          badge.classList.add('ring', 'ring-indigo-300');
          setTimeout(() => badge.classList.remove('ring', 'ring-indigo-300'), 700);
        }
      }
    });
  });
});
</script>