<%# Modern Cart UI with AJAX quantity controls. Expects @items = [{ product: Product | nil, product_id: Integer, quantity: Integer }, ...] %>

<%# Helper to pick the best available product image, with strong fallbacks %>
<% def product_image_src(product)
     # 1) no product at all -> basic placeholder
     return "https://via.placeholder.com/200x200.png?text=No+Image" unless product

     # 2) explicit image_url attribute
     if product.respond_to?(:image_url) && product.image_url.present?
       return product.image_url
     end

     # 3) associated product_images records
     if product.respond_to?(:product_images) && product.product_images.any?
       pi = product.product_images.first
       if pi.respond_to?(:image) && pi.image.present?
         begin
           return url_for(pi.image) if pi.image.respond_to?(:attached?) && pi.image.attached?
         rescue
         end
         return pi.image.to_s if pi.image.present?
       elsif pi.respond_to?(:image_url) && pi.image_url.present?
         return pi.image_url
       end
     end

     # 4) legacy string/url column :image on Product
     if product.respond_to?(:image) && product.image.present?
       begin
         return url_for(product.image) if product.image.respond_to?(:attached?) && product.image.attached?
       rescue
       end
       return product.image.to_s
     end

     # 5) fallback: use the same Unsplash-style placeholders used on category pages
     if product.respond_to?(:category) && product.category
       slug = product.category.name.to_s.downcase

       case slug
       when /table/
         return "https://images.unsplash.com/photo-1505692794400-7c6050b7c7d6?q=80&w=800&auto=format&fit=crop"
       when /textile/, /linen/, /bed/
         return "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?q=80&w=800&auto=format&fit=crop"
       when /decor/
         return "https://images.unsplash.com/photo-1524758631624-e2822e304c36?q=80&w=800&auto=format&fit=crop"
       when /light/
         return "https://images.unsplash.com/photo-1540574163026-643ea20ade25?q=80&w=800&auto=format&fit=crop"
       else
         return "https://images.unsplash.com/photo-1549187774-b4e9b0445b6b?q=80&w=800&auto=format&fit=crop"
       end
     end

     # 6) final safety
     "https://via.placeholder.com/200x200.png?text=No+Image"
   end
%>

<div class="max-w-6xl mx-auto px-4 py-10">
  <h1 class="text-3xl font-bold mb-6">Your Cart</h1>

  <%# ---------------------------------------------- %>
  <%# NEW: Last/Current Order Tracking (for customer) %>
  <%# Requires @last_order set in CartsController#show %>
  <%# ---------------------------------------------- %>
  <% if defined?(@last_order) && @last_order.present? %>
    <div class="bg-white rounded-lg shadow-sm border p-5 mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <div class="text-sm font-semibold text-gray-900">
            Your last order:
            <span class="text-indigo-600">
              <%= @last_order.order_number.presence || "##{@last_order.id}" %>
            </span>
          </div>

          <div class="text-xs text-gray-500 mt-1">
            Status: <span class="font-medium text-gray-800"><%= @last_order.status.to_s.humanize %></span>
            <% if @last_order.respond_to?(:tracking_number) && @last_order.tracking_number.present? %>
              • Tracking #: <span class="font-medium text-gray-800"><%= @last_order.tracking_number %></span>
            <% end %>
          </div>
        </div>

        <div class="flex gap-2">
          <%= link_to "View tracking",
                order_path(@last_order),
                class: "inline-flex items-center justify-center px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold shadow transition" %>
        </div>
      </div>

      <%# ---------------------------- %>
      <%# Clear tracking timeline + log %>
      <%# ---------------------------- %>
      <% if @last_order.respond_to?(:order_tracking_events) %>
        <% events = @last_order.order_tracking_events.to_a %>

        <div class="mt-4 border-t pt-4">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold text-gray-800">Shipment timeline</div>
            <div class="text-xs text-gray-500">
              Updated: <%= l((events.last&.happened_at || @last_order.updated_at), format: :short) rescue (events.last&.happened_at || @last_order.updated_at).to_s %>
            </div>
          </div>

          <% if events.any? %>
            <% current_index =
                 if @last_order.respond_to?(:status_step_index)
                   @last_order.status_step_index
                 else
                   0
                 end %>

            <% steps = [
              ['pending',    'Order placed'],
              ['paid',       'Payment confirmed'],
              ['processing', 'Processing'],
              ['shipped',    'Shipped'],
              ['delivered',  'Delivered'],
              ['received',   'Received']
            ] %>

            <div class="mt-3 bg-gray-50 rounded-lg border p-4">
              <ol class="space-y-3">
                <% steps.each_with_index do |(key, label), idx| %>
                  <% done = idx <= current_index %>
                  <% ev = events.reverse.find { |e| e.status.to_s == key.to_s } %>

                  <li class="flex items-start gap-3">
                    <div class="mt-1 flex flex-col items-center">
                      <span class="inline-block w-3 h-3 rounded-full <%= done ? 'bg-indigo-600' : 'bg-gray-300' %>"></span>
                      <% unless idx == steps.length - 1 %>
                        <span class="w-[2px] h-6 <%= done ? 'bg-indigo-300' : 'bg-gray-200' %>"></span>
                      <% end %>
                    </div>

                    <div class="flex-1">
                      <div class="flex items-center justify-between gap-3">
                        <div class="text-sm font-semibold <%= done ? 'text-gray-900' : 'text-gray-500' %>">
                          <%= label %>
                        </div>

                        <div class="text-xs text-gray-500">
                          <% if ev&.happened_at.present? %>
                            <%= l(ev.happened_at, format: :short) rescue ev.happened_at.to_s %>
                          <% elsif done %>
                            <span class="text-gray-400">Completed</span>
                          <% else %>
                            <span class="text-gray-400">Pending</span>
                          <% end %>
                        </div>
                      </div>

                      <% if ev&.location.present? %>
                        <div class="text-xs text-gray-500 mt-0.5">
                          Location: <%= ev.location %>
                        </div>
                      <% end %>

                      <% if ev&.message.present? %>
                        <div class="text-xs text-gray-600 mt-0.5"><%= ev.message %></div>
                      <% else %>
                        <% if key == 'shipped' && @last_order.respond_to?(:shipped_at) && @last_order.shipped_at.present? %>
                          <div class="text-xs text-gray-600 mt-0.5">
                            Shipped at: <%= l(@last_order.shipped_at, format: :short) rescue @last_order.shipped_at.to_s %>
                          </div>
                        <% end %>

                        <% if key == 'delivered' && @last_order.respond_to?(:delivered_at) && @last_order.delivered_at.present? %>
                          <div class="text-xs text-gray-600 mt-0.5">
                            Delivered at: <%= l(@last_order.delivered_at, format: :short) rescue @last_order.delivered_at.to_s %>
                          </div>
                        <% end %>
                      <% end %>
                    </div>
                  </li>
                <% end %>
              </ol>

              <div class="mt-4 pt-4 border-t">
                <details>
                  <summary class="cursor-pointer text-sm font-semibold text-indigo-700 hover:text-indigo-800">
                    View full history log
                  </summary>

                  <div class="mt-3 space-y-2">
                    <% events.reverse_each do |ev2| %>
                      <div class="flex items-start justify-between gap-4 bg-white rounded-lg border p-3">
                        <div>
                          <div class="text-sm font-semibold text-gray-900">
                            <%= ev2.status.to_s.humanize %>
                            <% if ev2.location.present? %>
                              <span class="text-xs font-normal text-gray-500">• <%= ev2.location %></span>
                            <% end %>
                          </div>
                          <% if ev2.message.present? %>
                            <div class="text-xs text-gray-600 mt-0.5"><%= ev2.message %></div>
                          <% end %>
                        </div>

                        <div class="text-xs text-gray-500 whitespace-nowrap">
                          <%= l(ev2.happened_at, format: :short) rescue ev2.happened_at.to_s %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </details>
              </div>
            </div>
          <% else %>
            <div class="mt-3 text-sm text-gray-500">
              Tracking history will appear here once the order status updates.
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>

  <% if @items.blank? %>
    <div class="bg-white rounded-lg p-8 shadow-sm">
      <p class="text-gray-700 mb-4">Your cart is empty.</p>
      <%= link_to "Continue shopping", categories_path, class: "inline-block px-5 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700" %>
    </div>
  <% else %>
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="overflow-x-auto">
        <table class="w-full text-left">
          <thead>
            <tr class="text-sm text-gray-600 border-b">
              <th class="py-3 pl-2">Item</th>
              <th class="py-3">Price</th>
              <th class="py-3">Qty</th>
              <th class="py-3 text-right pr-2">Subtotal</th>
            </tr>
          </thead>

          <tbody id="cart-rows" class="text-sm text-gray-800">
            <% total = 0 %>
            <% @items.each do |row| %>
              <% product = row[:product] %>
              <% qty = row[:quantity].to_i %>
              <% if product %>
                <% price = product.respond_to?(:price) ? product.price.to_f : 0.0 %>
                <% subtotal = price * qty %>
                <% total += subtotal %>

                <tr class="border-b" data-product-id="<%= product.id %>" data-price="<%= price %>">
                  <td class="py-4 pl-2 align-top">
                    <div class="flex items-start gap-4">
                      <div class="w-20 h-20 flex-shrink-0 rounded overflow-hidden bg-gray-50">
                        <%= image_tag product_image_src(product), alt: product.name, class: "w-full h-full object-cover" %>
                      </div>
                      <div class="flex-1">
                        <div class="font-semibold text-gray-900"><%= link_to product.name, product_path(product), class: "hover:underline" %></div>
                        <% if product.respond_to?(:sku) && product.sku.present? %>
                          <div class="text-xs text-gray-500 mt-1">SKU: <%= product.sku %></div>
                        <% end %>
                      </div>
                    </div>
                  </td>

                  <td class="py-4 align-top"><%= number_to_currency(price) %></td>

                  <td class="py-4 align-top">
                    <div class="inline-flex items-center gap-2">
                      <button type="button" class="decrease-qty inline-flex items-center justify-center w-8 h-8 rounded bg-gray-100 hover:bg-gray-200" title="Decrease">
                        &minus;
                      </button>

                      <span class="mx-2 px-3 py-1 rounded bg-gray-100 text-gray-700 qty-value"><%= qty %></span>

                      <button type="button" class="increase-qty inline-flex items-center justify-center w-8 h-8 rounded bg-indigo-600 text-white hover:bg-indigo-700" title="Increase">
                        &#43;
                      </button>
                    </div>
                  </td>

                  <td class="py-4 pr-2 font-semibold text-right align-top">
                    <span class="row-subtotal"><%= number_to_currency(subtotal) %></span>
                    <div class="mt-2">
                      <button type="button" class="remove-item text-sm text-red-600 hover:underline">
                        Remove
                      </button>
                    </div>
                  </td>
                </tr>
              <% else %>
                <% pid = row[:product_id] || 'unknown' %>
                <tr class="border-b bg-yellow-50" data-product-id="<%= pid %>" data-price="0">
                  <td class="py-4 pl-2">
                    <div class="flex items-start gap-4">
                      <div class="w-20 h-20 flex-shrink-0 rounded overflow-hidden bg-gray-50">
                        <%= image_tag product_image_src(nil), alt: "Missing product", class: "w-full h-full object-cover" %>
                      </div>
                      <div class="flex-1">
                        <div class="font-semibold text-gray-900">Product (ID: <%= pid %>)</div>
                        <div class="text-sm text-gray-600">This product no longer exists in the catalog.</div>
                      </div>
                    </div>
                  </td>

                  <td class="py-4 align-top">—</td>
                  <td class="py-4 align-top">
                    <span class="inline-flex items-center px-3 py-1 rounded bg-gray-100 text-gray-700"><%= qty %></span>
                  </td>
                  <td class="py-4 pr-2 font-semibold text-right align-top">—</td>
                </tr>
              <% end %>
            <% end %>

            <tr class="font-bold">
              <td colspan="3" class="py-4 text-right pr-2">Total</td>
              <td class="py-4 pr-2 font-bold text-right" id="cart-total"><%= number_to_currency(total) %></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-6 flex items-center justify-between gap-4">
        <div>
          <%= link_to "Continue shopping", categories_path, class: "px-4 py-2 border rounded-md text-sm" %>
        </div>

        <div class="flex items-center gap-3">
          <%= link_to "Proceed to Checkout", checkout_path, class: "px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700" %>
        </div>
      </div>
    </div>

    <!-- Client-side cart controls JS -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const csrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        function showError(msg) {
          alert(msg || 'Could not update the cart. Please try again.');
        }

        function updateBadge(count) {
          const el = document.getElementById('cart-count');
          if (!el) return;
          el.textContent = count;
        }

        function recalcTotal() {
          let total = 0.0;
          document.querySelectorAll('tbody#cart-rows tr[data-product-id]').forEach(row => {
            const price = parseFloat(row.dataset.price || 0);
            const qtyEl = row.querySelector('.qty-value');
            if (!qtyEl) return;
            const qty = parseInt(qtyEl.textContent || '0', 10);
            const subtotal = price * qty;
            const subtotalEl = row.querySelector('.row-subtotal');
            if (subtotalEl) subtotalEl.textContent = new Intl.NumberFormat(undefined, { style: 'currency', currency: '<%= (defined?(Money) ? Money.default_currency || "RS" : "RS") %>' }).format(subtotal);
            total += subtotal;
          });
          const totalEl = document.getElementById('cart-total');
          if (totalEl) totalEl.textContent = new Intl.NumberFormat(undefined, { style: 'currency', currency: '<%= (defined?(Money) ? Money.default_currency || "RS" : "RS") %>' }).format(total);
        }

        async function postAdd(productId) {
          try {
            const body = new URLSearchParams({ product_id: productId }).toString();
            const res = await fetch('/cart/add_item', {
              method: 'POST',
              headers: {
                'X-CSRF-Token': csrf,
                'Accept': 'application/json',
                'Content-Type': 'application/x-www-form-urlencoded'
              },
              credentials: 'same-origin',
              body
            });
            if (!res.ok) {
              showError();
              return null;
            }
            const ct = res.headers.get('content-type') || '';
            if (ct.indexOf('application/json') !== -1) {
              return await res.json();
            } else {
              return null;
            }
          } catch (err) {
            console.error(err);
            showError();
            return null;
          }
        }

        async function patchUpdate(productId, quantity) {
          try {
            const body = new URLSearchParams({ quantity: quantity }).toString();
            const res = await fetch(`/cart/update_item/${productId}`, {
              method: 'PATCH',
              headers: {
                'X-CSRF-Token': csrf,
                'Accept': 'application/json',
                'Content-Type': 'application/x-www-form-urlencoded'
              },
              credentials: 'same-origin',
              body
            });
            if (!res.ok) {
              showError();
              return null;
            }
            const ct = res.headers.get('content-type') || '';
            if (ct.indexOf('application/json') !== -1) {
              return await res.json();
            } else {
              return null;
            }
          } catch (err) {
            console.error(err);
            showError();
            return null;
          }
        }

        async function deleteRemove(productId) {
          try {
            const res = await fetch(`/cart/remove_item/${productId}`, {
              method: 'DELETE',
              headers: {
                'X-CSRF-Token': csrf,
                'Accept': 'application/json'
              },
              credentials: 'same-origin'
            });
            if (!res.ok) {
              showError();
              return null;
            }
            const ct = res.headers.get('content-type') || '';
            if (ct.indexOf('application/json') !== -1) {
              return await res.json();
            } else {
              return null;
            }
          } catch (err) {
            console.error(err);
            showError();
            return null;
          }
        }

        // Attach handlers
        document.querySelectorAll('tbody#cart-rows tr[data-product-id]').forEach(row => {
          const productId = row.dataset.productId;
          const incBtn = row.querySelector('.increase-qty');
          const decBtn = row.querySelector('.decrease-qty');
          const qtyEl = row.querySelector('.qty-value');
          const removeBtn = row.querySelector('.remove-item');

          if (incBtn) {
            incBtn.addEventListener('click', async (e) => {
              incBtn.disabled = true;
              const data = await postAdd(productId);
              incBtn.disabled = false;
              if (data && data.cart) {
                const newQty = data.cart[productId]?.toString() || qtyEl.textContent;
                qtyEl.textContent = newQty;
                if (typeof data.cart_count !== 'undefined') updateBadge(data.cart_count);
                recalcTotal();
              } else if (data === null) {
                location.reload();
              }
            });
          }

          if (decBtn) {
            decBtn.addEventListener('click', async (e) => {
              const currentQty = parseInt(qtyEl.textContent || '0', 10);
              if (currentQty <= 1) {
                if (!confirm('Remove this item from your cart?')) return;
                decBtn.disabled = true;
                const data = await deleteRemove(productId);
                decBtn.disabled = false;
                if (data && data.cart) {
                  if (!data.cart[productId] || parseInt(data.cart[productId]) <= 0) {
                    row.remove();
                  } else {
                    qtyEl.textContent = data.cart[productId];
                  }
                  if (typeof data.cart_count !== 'undefined') updateBadge(data.cart_count);
                  recalcTotal();
                } else if (data === null) {
                  location.reload();
                }
                return;
              }

              const newQty = currentQty - 1;
              decBtn.disabled = true;
              const data = await patchUpdate(productId, newQty);
              decBtn.disabled = false;
              if (data && data.cart) {
                qtyEl.textContent = data.cart[productId] || newQty;
                if (typeof data.cart_count !== 'undefined') updateBadge(data.cart_count);
                recalcTotal();
                if (!data.cart[productId] || parseInt(data.cart[productId]) <= 0) row.remove();
              } else if (data === null) {
                location.reload();
              }
            });
          }

          if (removeBtn) {
            removeBtn.addEventListener('click', async (e) => {
              if (!confirm('Remove this item from your cart?')) return;
              removeBtn.disabled = true;
              const data = await deleteRemove(productId);
              removeBtn.disabled = false;
              if (data && data.cart) {
                row.remove();
                if (typeof data.cart_count !== 'undefined') updateBadge(data.cart_count);
                recalcTotal();
              } else if (data === null) {
                location.reload();
              }
            });
          }
        });
      });
    </script>
  <% end %>
</div>