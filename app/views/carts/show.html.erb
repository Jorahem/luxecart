
<%= stylesheet_link_tag 'cart_checkout', media: 'all' %>

<main class="cart-page container">
  <h1>Your Cart</h1>

  <% if @cart_items.present? && @cart_items.any? %>
    <div class="cart-grid">
      <section class="cart-items">
        <ul id="cart-items-list">
          <%= render partial: 'carts/cart_item', collection: @cart_items, as: :cart_item %>
        </ul>
      </section>

      <aside class="cart-summary" id="order-summary">
        <%= render partial: 'carts/summary', locals: { cart: @cart } %>
      </aside>
    </div>
  <% else %>
    <div class="empty-cart">
      <p>Your cart is empty.</p>
      <%= link_to 'Continue shopping', root_path, class: 'btn btn-primary' %>
    </div>
  <% end %>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Delegate quantity buttons and remove actions
  const list = document.getElementById('cart-items-list');
  if (!list) return;

  function getCsrf() {
    const m = document.querySelector('meta[name="csrf-token"]');
    return m ? m.getAttribute('content') : '';
  }

  // Update item on server and refresh summary / subtotal in page
  async function updateItem(itemId, qty) {
    const url = "<%= url_for(controller: :carts, action: :update_item, id: ':ID') %>".replace(':ID', itemId);
    const resp = await fetch(url, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrf(), 'Accept': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ quantity: qty })
    });
    if (resp.ok) {
      const json = await resp.json();
      // update item subtotal if returned
      if (json.item_subtotal) {
        const itemEl = document.querySelector('.cart-item[data-id="' + itemId + '"]');
        const subEl = itemEl && itemEl.querySelector('.item-subtotal');
        if (subEl) subEl.textContent = json.item_subtotal;
      }
      // update order summary
      if (json.summary_html) {
        document.getElementById('order-summary').innerHTML = json.summary_html;
      }
    } else {
      console.error('Failed to update item');
    }
  }

  // Remove item
  async function removeItem(itemId, url) {
    const resp = await fetch(url, {
      method: 'DELETE',
      headers: { 'X-CSRF-Token': getCsrf(), 'Accept': 'application/json' },
      credentials: 'same-origin'
    });
    if (resp.ok) {
      const json = await resp.json();
      const li = document.querySelector('.cart-item[data-id="' + itemId + '"]');
      if (li) li.remove();
      if (json.summary_html) document.getElementById('order-summary').innerHTML = json.summary_html;
      // if empty now, reload to show empty state
      if (!document.querySelectorAll('.cart-item').length) window.location.reload();
    } else {
      console.error('Failed to remove item');
    }
  }

  list.addEventListener('click', function(e) {
    const inc = e.target.closest('.qty-btn.increase');
    const dec = e.target.closest('.qty-btn.decrease');
    if (inc || dec) {
      const btn = inc || dec;
      const li = btn.closest('.cart-item');
      const input = li.querySelector('.qty-input');
      let qty = parseInt(input.value || '1', 10);
      qty = inc ? qty + 1 : Math.max(1, qty - 1);
      input.value = qty;
      const id = li.dataset.id;
      updateItem(id, qty);
    }

    const rem = e.target.closest('.remove-btn');
    if (rem) {
      e.preventDefault();
      if (!confirm('Remove this item?')) return;
      const li = rem.closest('.cart-item');
      const id = li.dataset.id;
      const url = rem.getAttribute('data-remove-url') || rem.getAttribute('href');
      removeItem(id, url);
    }
  });

  list.addEventListener('change', function(e) {
    if (e.target.matches('.qty-input')) {
      const input = e.target;
      const li = input.closest('.cart-item');
      const qty = Math.max(1, parseInt(input.value || '1', 10));
      input.value = qty;
      updateItem(li.dataset.id, qty);
    }
  });
});
</script>