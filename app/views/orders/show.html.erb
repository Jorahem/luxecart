<% require 'ostruct' %>

<div class="min-h-[70vh] flex flex-col items-center justify-center bg-gray-50 px-2 pt-8 pb-12">
  <div class="bg-white shadow-xl rounded-2xl max-w-lg w-full p-8 animate-fade-in-down">

    <!-- Header / Animated checkmark -->
    <div class="flex flex-col items-center mb-6">
      <div class="rounded-full bg-green-100 border-2 border-green-300 flex items-center justify-center w-16 h-16 shadow-sm animate-bounce-in">
        <svg class="h-10 w-10 text-green-500" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
        </svg>
      </div>

      <h1 class="text-2xl font-extrabold text-indigo-600 mt-3 mb-1 tracking-tight">
        Order Confirmed!
      </h1>

      <p class="text-gray-500 text-sm text-center">
        Thank you â€” your order was received.<br>

        <%# Prefer order_number if present, else fallback to id %>
        <span class="text-xs text-indigo-400">
          Order #<%= @order.order_number.presence || @order.id %>
        </span>
      </p>

      <%# Status badge (new) %>
      <div class="mt-3">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold
                     <%= case @order.status.to_s
                         when 'pending' then 'bg-gray-100 text-gray-700 border border-gray-200'
                         when 'paid', 'processing' then 'bg-indigo-50 text-indigo-700 border border-indigo-100'
                         when 'shipped' then 'bg-blue-50 text-blue-700 border border-blue-100'
                         when 'delivered' then 'bg-green-50 text-green-700 border border-green-100'
                         when 'received' then 'bg-emerald-50 text-emerald-700 border border-emerald-100'
                         when 'cancelled' then 'bg-red-50 text-red-700 border border-red-100'
                         else 'bg-gray-100 text-gray-700 border border-gray-200'
                         end %>">
          Status: <%= @order.status.to_s.humanize %>
        </span>
      </div>
    </div>

    <%# -------------------------- %>
    <%# Tracking / Timeline (new) %>
    <%# -------------------------- %>
    <div class="mb-6">
      <h2 class="text-sm font-semibold text-gray-700 mb-2">Tracking</h2>

      <% steps = [
        ['pending',    'Order placed'],
        ['paid',       'Payment confirmed'],
        ['processing', 'Processing'],
        ['shipped',    'Shipped'],
        ['delivered',  'Delivered'],
        ['received',   'Received']
      ] %>

      <% current_index =
           if @order.respond_to?(:status_step_index)
             @order.status_step_index
           else
             # fallback if helper not present for any reason
             steps.map(&:first).index(@order.status.to_s) || 0
           end %>

      <div class="bg-gray-50 rounded-lg px-3 py-3 border text-gray-700 shadow-sm">
        <ol class="space-y-2">
          <% steps.each_with_index do |(key, label), idx| %>
            <% done = idx <= current_index %>
            <li class="flex items-start gap-2">
              <span class="mt-1 inline-block w-3 h-3 rounded-full <%= done ? 'bg-indigo-600' : 'bg-gray-300' %>"></span>
              <div class="flex-1">
                <div class="text-sm font-medium <%= done ? 'text-gray-900' : 'text-gray-500' %>">
                  <%= label %>
                </div>

                <% if key == 'shipped' && @order.respond_to?(:shipped_at) && @order.shipped_at.present? %>
                  <div class="text-xs text-gray-500">Shipped at: <%= l(@order.shipped_at, format: :long) rescue @order.shipped_at %></div>
                <% end %>

                <% if key == 'delivered' && @order.respond_to?(:delivered_at) && @order.delivered_at.present? %>
                  <div class="text-xs text-gray-500">Delivered at: <%= l(@order.delivered_at, format: :long) rescue @order.delivered_at %></div>
                <% end %>
              </div>
            </li>
          <% end %>
        </ol>

        <div class="mt-4 pt-3 border-t border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <div class="text-xs text-gray-500">Tracking number</div>
            <div class="text-sm font-semibold text-gray-900">
              <%= @order.tracking_number.presence || 'Not yet available' %>
            </div>
          </div>

          <%# Customer action: mark received (uses OrdersController#mark_received) %>
          <% if @order.respond_to?(:can_mark_received?) ? @order.can_mark_received? : (@order.status.to_s == 'delivered') %>
            <%= button_to 'Mark as received',
                  mark_received_order_path(@order),
                  method: :patch,
                  class: 'inline-flex items-center justify-center px-4 py-2 text-white bg-emerald-600 hover:bg-emerald-700 rounded-full text-sm font-semibold shadow transition' %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Shipping Info (existing) -->
    <div class="mb-6">
      <h2 class="text-sm font-semibold text-gray-700 mb-1">Shipping To</h2>
      <div class="bg-gray-50 rounded-lg px-3 py-2 border text-gray-700 shadow-sm">
        <div class="font-medium"><%= @order.shipping_full_name %></div>
        <div><%= @order.shipping_street %></div>
        <div><%= [@order.shipping_city, @order.shipping_state, @order.shipping_postal_code].compact.join(', ') %></div>
      </div>
    </div>

    <!-- Order Summary (existing) -->
    <div class="mb-4">
      <h2 class="text-sm font-semibold text-gray-700 mb-1">Order Summary</h2>
      <div class="rounded-xl bg-white border-2 border-indigo-50 shadow px-2 pt-2 pb-1 animate-fade-in">
        <%= render 'checkout/order_summary', cart: OpenStruct.new(
          cart_items: @order.order_items.map { |oi|
            OpenStruct.new(product: oi.product, quantity: oi.quantity, line_subtotal: oi.total_price)
          },
          subtotal: @order.subtotal,
          shipping_cost: @order.shipping_cost,
          tax_amount: (@order.respond_to?(:tax_amount) && @order.tax_amount.present?) ? @order.tax_amount : @order.tax,
          total_price: @order.total_price
        ) %>
      </div>
    </div>

    <div class="flex justify-center mt-6">
      <a href="<%= products_path %>" class="inline-flex items-center px-5 py-2 text-white bg-indigo-600 hover:bg-indigo-700 rounded-full font-semibold shadow transition transform hover:-translate-y-0.5 animate-fade-in">
        <i class="fa fa-arrow-left mr-2"></i>
        Continue Shopping
      </a>
    </div>
  </div>
</div>

<!-- Animations (kept from your existing file) -->
<style>
@keyframes fade-in-down {
  0% { opacity: 0; transform: translateY(-40px);}
  100% { opacity: 1; transform: none;}
}
@keyframes fade-in {
  0% { opacity: 0;}
  100% { opacity: 1;}
}
@keyframes bounce-in {
  0% { transform: scale(0.7);}
  65% { transform: scale(1.15);}
  80% { transform: scale(0.92);}
  100% { transform: scale(1);}
}
.animate-fade-in-down { animation: fade-in-down 0.6s cubic-bezier(.76,.13,.27,.87) both;}
.animate-fade-in { animation: fade-in 0.7s .16s both;}
.animate-bounce-in { animation: bounce-in 0.7s cubic-bezier(.6,-0.36,.73,.95) both;}
</style>