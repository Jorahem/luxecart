<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title><%= @product&.name || "Product" %></title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <%= stylesheet_link_tag "application", media: "all" %>
</head>
<body class="product-page">
  <main class="product-container">
    <% if @product %>
      <div class="product-show grid">
        <div class="left">
          <%# Determine an image source from several options %>
          <% image_src = nil %>

          <%# 1) explicit image_url attribute if present %>
          <% if @product.respond_to?(:image_url) && @product.image_url.present? %>
            <% image_src = @product.image_url %>

          <%# 2) legacy string column like 'image' that stores a URL/path %>
          <% elsif @product.respond_to?(:image) %>
            <% begin %>
              <% if @product.image.present? && !@product.image.respond_to?(:attached?) %>
                <% image_src = @product.image %>
              <% end %>
            <% rescue %>
              <%# swallow any unexpected errors from legacy attributes %>
            <% end %>
          <% end %>

          <%# 3) ActiveStorage attachment check if no image_src chosen yet %>
          <% if image_src.blank? && @product.respond_to?(:image) && @product.image.respond_to?(:attached?) && @product.image.attached? %>
            <%= image_tag url_for(@product.image), alt: @product.name, class: "product-show-image" %>
          <% elsif image_src.present? %>
            <img src="<%= image_src %>" alt="<%= @product.name %>" class="product-show-image" />
          <% else %>
            <div class="placeholder-image large">No image</div>
          <% end %>
        </div>

        <div class="right">
          <h1><%= @product.name %></h1>

          <% if @product.respond_to?(:price) && @product.price.present? %>
            <p class="price"><%= number_to_currency(@product.price) %></p>
          <% elsif @product.respond_to?(:price_cents) && @product.price_cents.present? %>
            <p class="price"><%= number_to_currency(BigDecimal(@product.price_cents) / 100) %></p>
          <% end %>

          <div class="description">
            <%= simple_format(@product.description.to_s) %>
          </div>

     
          <%# add-to-cart form/button (uses /cart/add_item route) %>
          <%= form_with url: cart_add_item_path, method: :post, local: true, html: { class: 'add-to-cart' } do |f| %>
            <%= hidden_field_tag :product_id, @product.id %>
            <%= number_field_tag :quantity, 1, min: 1, class: "qty-input" %>
            <%= f.submit "Add to cart", class: "btn btn-primary" %>
          <% end %>

          <%# Back button: go to previous page if possible, otherwise products list %>
          <div style="margin-top: 12px;">
            <% back_path =
                 if request.referer.present? && URI(request.referer).path != request.path
                   request.referer
                 else
                   products_path
                 end %>

            <%= link_to "Back", back_path, class: "btn btn-secondary" %>
          </div>

      
        </div>
      </div>
    <% else %>
      <div class="not-found">
        <h2>Product not found</h2>
        <p>The product you requested doesn't exist or has been removed.</p>
        <%= link_to "Back to products", products_path, class: "btn btn-secondary" %>
      </div>
    <% end %>
  </main>
</body>
</html>