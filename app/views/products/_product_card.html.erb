<div class="rounded-lg border p-4 bg-white flex flex-col h-full">
  <%# product variable expected in local assigns %>

  <%# Image (ActiveStorage or image_url fallback) %>
  <% img_src = if product.respond_to?(:image) && product.image.present?
                 begin
                   url_for(product.image) if product.image.respond_to?(:attached?) && product.image.attached?
                 rescue
                   nil
                 end
               end
               img_src ||= product.respond_to?(:image_url) ? product.image_url : nil
               img_src ||= product.product_images&.first&.image if product.respond_to?(:product_images)
               img_src ||= asset_path('placeholder-400x300.png') rescue '/images/placeholder-400x300.png' %>

  <%= link_to product_path(product), class: "block mb-3" do %>
    <img src="<%= img_src.presence || 'https://via.placeholder.com/400x300?text=No+Image' %>"
         alt="<%= h(product.name) %>"
         class="w-full h-40 object-cover rounded-md">
  <% end %>

  <div class="flex-1">
    <h3 class="text-sm font-semibold text-gray-900 mb-1">
      <%= link_to product.name, product_path(product), class: "hover:underline" %>
    </h3>

    <% if product.respond_to?(:short_description) && product.short_description.present? %>
      <p class="text-xs text-gray-500 mb-2"><%= truncate(product.short_description, length: 80) %></p>
    <% end %>

    <div class="text-gray-800 font-medium mb-3"><%= number_to_currency(product.try(:price) || 0) %></div>
  </div>

  <div class="mt-2 grid grid-cols-2 gap-2">
    <%# Primary Add button â€” uses JS handler (data attributes) and falls back gracefully %>
    <%= button_tag type: :button,
                   class: "add-to-cart-ajax inline-flex items-center justify-center px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm w-full",
                   data: { url: (defined?(cart_add_item_path) ? cart_add_item_path : '/cart/add_item'), product_id: product.id },
                   aria: { label: "Add #{product.name} to cart" } do %>
      <i class="fa-solid fa-cart-plus mr-2"></i>
      Add
    <% end %>

    <%# Optional: Quick view or details link %>
    <%= link_to product_path(product), class: "inline-flex items-center justify-center px-3 py-2 border rounded-md text-sm text-gray-700 hover:bg-gray-50 w-full", title: "View details for #{product.name}" do %>
      <i class="fa-solid fa-eye mr-2"></i> View
    <% end %>
  </div>
</div>