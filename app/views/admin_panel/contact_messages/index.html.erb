<% content_for :title, "Messages | LuxeCart Admin" %>

<main class="px-4 py-10 min-h-screen" style="background: linear-gradient(100deg, #e0e7ff 60%, #f3e8ff 100%);">
  <div class="max-w-7xl mx-auto">

    <% unread_count = ContactMessage.unread.count rescue 0 %>
    <% total_count = @contact_messages.size %>

    <!-- HEADER -->
    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4 mb-8">
      <div>
        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-indigo-600 to-purple-600 text-xs font-bold text-white mb-4 shadow-lg">
          <span class="h-2 w-2 rounded-full bg-white animate-pulse"></span>
          Customer Support
        </div>
        <h1 class="text-5xl font-extrabold text-indigo-900 mb-2 tracking-tight drop-shadow-sm">Messages & Inbox</h1>
        <p class="text-lg text-purple-700 mb-3 font-semibold">Manage customer inquiries and support requests</p>
      </div>
      <div class="flex items-center gap-3">
        <%= link_to admin_dashboard_path,
              class: "px-6 py-3 rounded-xl bg-white/90 backdrop-blur-sm text-indigo-700 text-sm font-bold shadow-lg hover:shadow-xl hover:bg-white transition-all duration-200 flex items-center gap-2 border border-indigo-200" do %>
          <i class="fas fa-arrow-left"></i> Back
        <% end %>
      </div>
    </div>

    <!-- STATS -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <% stats = [
        ["Total Messages", total_count, "from-indigo-500 to-indigo-600", "text-white", "fa-envelope"],
        ["Unread", unread_count, "from-amber-400 to-yellow-500", "text-amber-900", "fa-envelope-open"],
        ["Read", total_count - unread_count, "from-emerald-500 to-green-600", "text-white", "fa-check-circle"],
        ["Today", @contact_messages.select { |m| m.created_at.to_date == Date.today }.size, "from-purple-500 to-fuchsia-600", "text-white", "fa-calendar-day"]
      ] %>
      <% stats.each do |label, value, gradient, text_color, icon| %>
        <div class="rounded-2xl bg-gradient-to-br <%= gradient %> shadow-lg hover:shadow-xl transition-all duration-200 p-5 flex flex-col items-center justify-center <%= text_color %> transform hover:scale-105">
          <i class="fas <%= icon %> text-2xl mb-2 opacity-90"></i>
          <div class="text-xs font-bold uppercase tracking-wide opacity-90 mb-1"><%= label %></div>
          <div class="text-3xl font-extrabold"><%= value %></div>
        </div>
      <% end %>
    </div>

    <!-- MESSAGES GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- LEFT: Message List -->
      <div class="lg:col-span-1">
        <div class="rounded-2xl shadow-2xl border border-purple-200 overflow-hidden bg-white">
          <!-- Search Header -->
          <div class="px-6 py-4 border-b border-purple-100 bg-gradient-to-r from-indigo-50 to-purple-50">
            <div class="relative">
              <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-indigo-400"></i>
              <input
                type="text"
                placeholder="Search messages..."
                class="w-full pl-11 pr-4 py-3 rounded-xl border-2 border-indigo-200 text-indigo-900 bg-white font-medium focus:outline-none focus:ring-2 focus:ring-purple-400 focus:border-transparent shadow-sm placeholder-indigo-300"
                onkeyup="filterMessages(this.value)"
              />
            </div>
          </div>

          <!-- Messages List -->
          <div class="max-h-[600px] overflow-y-auto" id="messages-list">
            <% if @contact_messages.present? %>
              <% @contact_messages.each_with_index do |message, index| %>
                <%= link_to admin_contact_message_path(message), 
                      class: "message-item block border-b border-purple-50 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 transition-all duration-150 #{'bg-amber-50' unless message.read?}",
                      data: { 
                        name: message.name,
                        email: message.email,
                        subject: message.subject
                      } do %>
                  <div class="px-6 py-4">
                    <div class="flex items-start gap-3">
                      <!-- Avatar -->
                      <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-white font-bold text-lg shadow-md flex-shrink-0">
                        <%= message.name.to_s.first&.upcase || 'U' %>
                      </div>

                      <!-- Message Info -->
                      <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between gap-2">
                          <div class="font-bold text-indigo-900 truncate">
                            <%= message.name %>
                          </div>
                          <% if message.read? %>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-bold bg-emerald-100 text-emerald-700 flex-shrink-0">
                              <i class="fas fa-check mr-1"></i>Read
                            </span>
                          <% else %>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-bold bg-amber-100 text-amber-700 flex-shrink-0 animate-pulse">
                              <i class="fas fa-circle mr-1"></i>New
                            </span>
                          <% end %>
                        </div>

                        <div class="text-xs text-indigo-600 truncate mt-0.5">
                          <%= message.email %>
                        </div>

                        <div class="text-sm text-indigo-900 font-semibold truncate mt-2">
                          <%= message.subject.presence || "No subject" %>
                        </div>

                        <div class="text-xs text-slate-500 truncate mt-1">
                          <%= truncate(message.message, length: 60) %>
                        </div>

                        <div class="flex items-center gap-2 mt-2 text-[10px] text-slate-400">
                          <i class="far fa-clock"></i>
                          <%= time_ago_in_words(message.created_at) %> ago
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            <% else %>
              <!-- Empty State -->
              <div class="px-6 py-16 text-center">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center">
                  <i class="fas fa-inbox text-4xl text-indigo-400"></i>
                </div>
                <h3 class="text-lg font-bold text-indigo-900 mb-2">No Messages Yet</h3>
                <p class="text-sm text-slate-600">Messages from customers will appear here</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- RIGHT: Message Preview & Quick Stats -->
      <div class="lg:col-span-2 space-y-6">
        
        <!-- Preview Card -->
        <div class="rounded-2xl shadow-2xl border border-purple-200 overflow-hidden bg-white">
          <div class="px-6 py-5 border-b border-purple-100 bg-gradient-to-r from-indigo-600 to-purple-600">
            <h2 class="text-2xl font-bold text-white flex items-center gap-3">
              <i class="fa-solid fa-eye text-purple-200"></i> 
              Message Preview
            </h2>
            <p class="text-sm text-indigo-100 mt-1">Select a message from the list to view details</p>
          </div>

          <div class="p-8">
            <div class="text-center py-12">
              <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center">
                <i class="fas fa-hand-pointer text-5xl text-indigo-400"></i>
              </div>
              <h3 class="text-2xl font-bold text-indigo-900 mb-3">Select a Message</h3>
              <p class="text-slate-600 max-w-md mx-auto">
                Click on any message from the left panel to view its full content and take action
              </p>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Tips Card -->
          <div class="rounded-2xl bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 p-6">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white flex-shrink-0">
                <i class="fas fa-lightbulb"></i>
              </div>
              <div>
                <h3 class="text-lg font-bold text-indigo-900 mb-2">Quick Tips</h3>
                <ul class="space-y-2 text-sm text-indigo-700">
                  <li class="flex items-start gap-2">
                    <i class="fas fa-check text-emerald-600 mt-0.5"></i>
                    <span>Reply within 24 hours for best customer experience</span>
                  </li>
                  <li class="flex items-start gap-2">
                    <i class="fas fa-check text-emerald-600 mt-0.5"></i>
                    <span>Mark messages as read to keep inbox organized</span>
                  </li>
                  <li class="flex items-start gap-2">
                    <i class="fas fa-check text-emerald-600 mt-0.5"></i>
                    <span>Use professional and friendly tone</span>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Stats Card -->
          <div class="rounded-2xl bg-gradient-to-br from-purple-50 to-fuchsia-50 border-2 border-purple-200 p-6">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-fuchsia-600 flex items-center justify-center text-white flex-shrink-0">
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-bold text-purple-900 mb-3">Response Stats</h3>
                <div class="space-y-2">
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-purple-700">Avg. Response Time</span>
                    <span class="font-bold text-purple-900">< 2 hours</span>
                  </div>
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-purple-700">This Week</span>
                    <span class="font-bold text-purple-900"><%= @contact_messages.select { |m| m.created_at > 1.week.ago }.size %> messages</span>
                  </div>
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-purple-700">Response Rate</span>
                    <span class="font-bold text-emerald-600">98%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>

  </div>
</main>

<script>
  // Simple client-side search filter
  function filterMessages(searchTerm) {
    const term = searchTerm.toLowerCase();
    const messages = document.querySelectorAll('.message-item');
    
    messages.forEach(message => {
      const name = message.dataset.name?.toLowerCase() || '';
      const email = message.dataset.email?.toLowerCase() || '';
      const subject = message.dataset.subject?.toLowerCase() || '';
      
      const matches = name.includes(term) || email.includes(term) || subject.includes(term);
      message.style.display = matches ? 'block' : 'none';
    });
  }
</script>