<% require 'ostruct' %>


<% status_options = Order.statuses.keys.map { |k| [k.humanize, k] } %>
<% current_status_key = @order.status.to_s %>
<% current_status_label = status_options.find { |(_l, k)| k == current_status_key }&.first || current_status_key.humanize %>

<%# New background: subtle indigo/teal gradient + soft pattern %>
<div class="min-h-[70vh] px-4 py-10 text-white bg-gradient-to-br from-slate-950 via-indigo-950 to-slate-950">
  <div class="max-w-5xl mx-auto relative">
    <div class="pointer-events-none absolute -top-20 -left-20 w-80 h-80 rounded-full bg-indigo-600/10 blur-3xl"></div>
    <div class="pointer-events-none absolute -bottom-24 -right-24 w-96 h-96 rounded-full bg-cyan-500/10 blur-3xl"></div>

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl font-extrabold">
          Order <span class="text-indigo-200"><%= @order.order_number.presence || "##{@order.id}" %></span>
        </h1>
        <p class="text-sm text-indigo-100/70 mt-1">
          Created <%= l(@order.created_at, format: :long) rescue @order.created_at.to_s %>
          <% if @order.user&.email.present? %>
            â€¢ Customer: <span class="font-semibold text-white"><%= @order.user.email %></span>
          <% end %>
        </p>
      </div>

      <div class="flex items-center gap-2">
        <%= link_to "Back",
              admin_orders_path,
              class: "px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-white hover:bg-white/10 text-sm font-semibold" %>
      </div>
    </div>

    <!-- Update card -->
    <div class="bg-white/5 backdrop-blur border border-white/10 rounded-2xl p-6 mb-6 shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-sm font-extrabold text-white">Update order</h2>

        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border
                     <%= case @order.status.to_s
                         when 'pending' then 'bg-white/5 text-white border-white/10'
                         when 'paid', 'processing' then 'bg-indigo-500/10 text-indigo-100 border-indigo-400/20'
                         when 'shipped' then 'bg-sky-500/10 text-sky-100 border-sky-400/20'
                         when 'delivered' then 'bg-green-500/10 text-green-100 border-green-400/20'
                         when 'received' then 'bg-emerald-500/10 text-emerald-100 border-emerald-400/20'
                         when 'cancelled' then 'bg-red-500/10 text-red-100 border-red-400/20'
                         else 'bg-white/5 text-white border-white/10'
                         end %>">
          Current: <%= @order.status.to_s.humanize %>
        </span>
      </div>

      <%= form_with model: @order, url: admin_order_path(@order), method: :patch, local: true do %>
        <!-- Hidden status (custom dropdown sets this) -->
        <%= hidden_field_tag "order[status]", current_status_key, id: "order_status" %>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Custom dropdown (NO native select) -->
          <div>
            <label class="block text-xs font-bold text-indigo-100/80 mb-2">Status</label>

            <div class="relative" id="status-dd">
              <button
                type="button"
                id="status-dd-btn"
                class="w-full flex items-center justify-between bg-slate-950/40 text-white border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-400"
              >
                <span id="status-label" class="font-semibold"><%= current_status_label %></span>
                <svg class="h-4 w-4 text-indigo-100/70" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
                </svg>
              </button>

              <div
                id="status-dd-menu"
                class="hidden absolute z-50 mt-2 w-full bg-slate-950 border border-white/10 rounded-xl shadow-2xl overflow-hidden"
              >
                <% status_options.each do |label, key| %>
                  <button
                    type="button"
                    class="w-full text-left px-4 py-3 text-sm hover:bg-white/5 <%= key == current_status_key ? 'bg-white/5 text-indigo-100' : 'text-white' %>"
                    data-status-key="<%= key %>"
                    data-status-label="<%= label %>"
                  >
                    <div class="flex items-center justify-between">
                      <span class="font-semibold"><%= label %></span>
                      <% if key == current_status_key %>
                        <span class="text-xs text-indigo-200">selected</span>
                      <% end %>
                    </div>
                  </button>
                <% end %>
              </div>
            </div>

            <p class="text-[11px] text-indigo-100/60 mt-2">Updates customer tracking timeline.</p>
          </div>

          <!-- Tracking number -->
          <div>
            <label class="block text-xs font-bold text-indigo-100/80 mb-2">Tracking number</label>
            <%= text_field_tag "order[tracking_number]", @order.tracking_number,
                  placeholder: "e.g. DHL123456789",
                  class: "w-full bg-slate-950/40 text-white border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-400" %>
            <p class="text-[11px] text-indigo-100/60 mt-2">Optional. Visible to customer.</p>
          </div>

          <!-- Submit -->
          <div class="flex items-end">
            <button type="submit"
              class="w-full px-4 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-extrabold shadow transition">
              Update
            </button>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Timeline preview -->
    <div class="bg-white/5 backdrop-blur border border-white/10 rounded-2xl p-6 shadow-xl">
      <h2 class="text-sm font-extrabold text-white mb-3">Customer tracking preview</h2>

      <% steps = [
        ['pending',    'Order placed'],
        ['paid',       'Payment confirmed'],
        ['processing', 'Processing'],
        ['shipped',    'Shipped'],
        ['delivered',  'Delivered'],
        ['received',   'Received']
      ] %>

      <% current_index =
           if @order.respond_to?(:status_step_index)
             @order.status_step_index
           else
             steps.map(&:first).index(@order.status.to_s) || 0
           end %>

      <div class="bg-slate-950/30 rounded-xl border border-white/10 p-4">
        <ol class="space-y-2">
          <% steps.each_with_index do |(key, label), idx| %>
            <% done = idx <= current_index %>
            <li class="flex items-start gap-3">
              <span class="mt-1 inline-block w-3 h-3 rounded-full <%= done ? 'bg-indigo-400' : 'bg-white/20' %>"></span>
              <div class="flex-1">
                <div class="text-sm font-semibold <%= done ? 'text-white' : 'text-indigo-100/60' %>">
                  <%= label %>
                </div>
              </div>
            </li>
          <% end %>
        </ol>

        <div class="mt-4 pt-3 border-t border-white/10 flex items-center justify-between">
          <div>
            <div class="text-xs text-indigo-100/60">Tracking number</div>
            <div class="text-sm font-bold text-white">
              <%= @order.tracking_number.presence || 'Not yet available' %>
            </div>
          </div>

          <div class="text-xs text-indigo-100/60">
            Status: <span class="font-semibold text-white"><%= @order.status.to_s.humanize %></span>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  (function () {
    const btn = document.getElementById('status-dd-btn');
    const menu = document.getElementById('status-dd-menu');
    const label = document.getElementById('status-label');
    const input = document.getElementById('order_status');

    function close() { menu && menu.classList.add('hidden'); }
    function toggle() { if (menu) menu.classList.toggle('hidden'); }

    document.addEventListener('click', function (e) {
      const opt = e.target.closest('[data-status-key]');
      if (opt) {
        const key = opt.getAttribute('data-status-key');
        const text = opt.getAttribute('data-status-label');
        if (input) input.value = key;
        if (label) label.textContent = text;
        close();
        return;
      }

      if (btn && (e.target === btn || btn.contains(e.target))) {
        toggle();
        return;
      }

      if (!e.target.closest('#status-dd')) close();
    });

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') close();
    });
  })();
</script>