// app/assets/javascripts/store.js
// Shared add-to-cart utilities and handlers (forms + buttons)
//
// - Supports:
//   - form.add-to-cart (Rails button_to fallback forms)
//   - elements with data-product-id (selectors: .add-to-cart[data-product-id])
//   - elements with .add-to-cart-ajax (newer pattern used across category pages)
// - Reads dataset.productId or dataset.product_id (both supported)
// - If a button has no product id but its data-url contains a product_id query param, that id is used
// - Updates cart badge when server returns cart_count (robust to multiple response shapes)
// - Shows a small toast on success/error
document.addEventListener('DOMContentLoaded', function () {
  function getCsrf() {
    var m = document.querySelector('meta[name="csrf-token"]');
    return m ? m.getAttribute('content') : '';
  }

  // small toast helper
  function showToast(message, isError) {
    var root = document.getElementById('toast-root') || (function() {
      var el = document.createElement('div');
      el.id = 'toast-root';
      el.style.position = 'fixed';
      el.style.top = '12px';
      el.style.right = '12px';
      el.style.zIndex = 9999;
      document.body.appendChild(el);
      return el;
    })();

    var el = document.createElement('div');
    el.className = isError ? 'toast toast-error' : 'toast toast-success';
    el.style.background = isError ? '#fee2e2' : '#fff';
    el.style.color = isError ? '#991b1b' : '#111';
    el.style.borderRadius = '6px';
    el.style.padding = '10px 14px';
    el.style.boxShadow = '0 4px 10px rgba(0,0,0,0.08)';
    el.style.marginTop = '8px';
    el.textContent = message;
    root.appendChild(el);
    setTimeout(function () { el.remove(); }, 3500);
  }

  function setCartCount(count) {
    var el = document.getElementById('cart-count');
    if (!el) return;
    el.textContent = count;
  }

  function incrementCartCount(by) {
    by = by || 1;
    var el = document.getElementById('cart-count');
    if (!el) return;
    var current = parseInt(el.textContent || '0', 10) || 0;
    setCartCount(current + by);
  }

  // Try to read product_id from a URL's querystring (if present)
  function productIdFromUrl(url) {
    try {
      var u = new URL(url, window.location.origin);
      return u.searchParams.get('product_id') || u.searchParams.get('productId') || null;
    } catch (e) {
      // fallback: simple regex
      var m = (url || '').match(/[?&]product_id=(\d+)/);
      return m ? m[1] : null;
    }
  }

  // Normalize server response to find cart_count (several shapes may exist in your app)
  function extractCartCount(json) {
    if (!json) return null;
    if (typeof json.cart_count === 'number') return json.cart_count;
    if (json.cart && typeof json.cart_count === 'number') return json.cart_count;
    // If server returned session cart hash { "3": 1, "5": 2 } in json.cart, sum values
    if (json.cart && typeof json.cart === 'object') {
      try {
        var sum = 0;
        Object.keys(json.cart).forEach(function (k) {
          var v = parseInt(json.cart[k], 10);
          if (!isNaN(v)) sum += v;
        });
        return sum;
      } catch (e) {
        return null;
      }
    }
    return null;
  }

  // Generic add-to-cart poster used by buttons and forms
  async function postAddToCart(url, payloadObj) {
    // payloadObj may be null (we will POST URL query-only). Prefer JSON body when possible.
    var headers = {
      'X-CSRF-Token': getCsrf(),
      'Accept': 'application/json'
    };

    var options = {
      method: 'POST',
      headers: headers,
      credentials: 'same-origin'
    };

    if (payloadObj) {
      headers['Content-Type'] = 'application/json';
      options.body = JSON.stringify(payloadObj);
    } else {
      // no body: still include Content-Type for consistency
      headers['Content-Type'] = 'application/x-www-form-urlencoded';
      options.body = '';
    }

    try {
      var res = await fetch(url || '/cart/add_item', options);
      var ct = res.headers.get('content-type') || '';
      if (res.ok && ct.indexOf('application/json') !== -1) {
        var json = await res.json().catch(function(){ return null; });
        return { ok: true, json: json, status: res.status };
      } else if (res.ok) {
        return { ok: true, json: null, status: res.status };
      } else {
        var errText = await res.text().catch(function(){ return null; });
        return { ok: false, error: errText || ('status ' + res.status), status: res.status };
      }
    } catch (err) {
      return { ok: false, error: err.message || err };
    }
  }

  // --------------------------
  // 1) Handle forms generated by Rails' button_to (form.add-to-cart)
  // --------------------------
  document.querySelectorAll('form.add-to-cart').forEach(function (form) {
    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      // LOGIN CHECK START
      if (typeof window.currentUserLoggedIn !== "undefined" && !window.currentUserLoggedIn) {
        alert('Login first');
        window.location.href = '/users/sign_in';
        return;
      }
      // LOGIN CHECK END
      var url = form.action || '/cart/add_item';
      var formData = new FormData(form);

      // Convert FormData to an object (for JSON body) when possible
      var obj = {};
      formData.forEach(function (v, k) { obj[k] = v; });

      var btn = form.querySelector('button[type="submit"]') || form.querySelector('input[type="submit"]');
      if (btn) { btn.disabled = true; }
      try {
        var result = await postAddToCart(url, obj);
        if (result.ok) {
          var cartCount = extractCartCount(result.json);
          if (cartCount !== null) setCartCount(cartCount);
          showToast((result.json && result.json.message) || 'Added to cart');
        } else {
          showToast('Could not add to cart', true);
          console.error('Add to cart error (form):', result.error);
        }
      } finally {
        if (btn) { setTimeout(function(){ try { btn.disabled = false; } catch(e){} }, 250); }
      }
    });
  });

  // --------------------------
  // 2) Handle non-form buttons: data-product-id or add-to-cart-ajax
  //    (supports elements with either .add-to-cart[data-product-id] or .add-to-cart-ajax)
  // --------------------------
  var selectors = '.add-to-cart[data-product-id], .add-to-cart-ajax, .add-to-cart[data-product-id] *';
  // collect elements: for .add-to-cart[data-product-id] and .add-to-cart-ajax
  var els = Array.prototype.slice.call(document.querySelectorAll('.add-to-cart[data-product-id], .add-to-cart-ajax'));

  // Additionally include elements that have data-product-id attribute even if class differs
  Array.prototype.slice.call(document.querySelectorAll('[data-product-id]')).forEach(function(e){
    if (els.indexOf(e) === -1) els.push(e);
  });

  els.forEach(function (el) {
    // skip if inside a form (form handler already handles it)
    if (el.closest && el.closest('form')) return;

    el.addEventListener('click', async function (e) {
      e.preventDefault();
      // LOGIN CHECK START
      if (typeof window.currentUserLoggedIn !== "undefined" && !window.currentUserLoggedIn) {
        alert('Login first');
        window.location.href = '/users/sign_in';
        return;
      }
      // LOGIN CHECK END

      // Get product id from dataset (support both productId and product_id variants)
      var pid = el.dataset ? (el.dataset.productId || el.dataset.product_id) : null;
      var qty = el.dataset ? (el.dataset.quantity || el.dataset.qty || 1) : 1;
      var url = el.dataset ? (el.dataset.url || el.getAttribute('data-url') || '/cart/add_item') : '/cart/add_item';

      // If no pid, try to parse from url query (some templates set product_id in the URL)
      if (!pid && url) {
        var parsed = productIdFromUrl(url);
        if (parsed) pid = parsed;
      }

      if (!pid) {
        showToast('Product not found', true);
        console.warn('Add to cart clicked but no product id available on element:', el);
        return;
      }

      // disable element while request in flight
      try {
        el.disabled = true;
      } catch (ignored) {}

      // send JSON payload; if URL already encodes product_id it's fine to include it in body too
      var payload = { product_id: pid, quantity: qty };

      var result = await postAddToCart(url, payload);

      if (result.ok) {
        var cartCount = extractCartCount(result.json);
        if (cartCount !== null) {
          setCartCount(cartCount);
        } else {
          // fallback: increment by 1
          incrementCartCount(1);
        }

        showToast((result.json && result.json.message) || 'Added to cart');

        // visual badge pulse
        var badge = document.getElementById('cart-count');
        if (badge) {
          badge.classList.add('ring', 'ring-indigo-300');
          setTimeout(function () { badge.classList.remove('ring', 'ring-indigo-300'); }, 700);
        }

        // debug log (remove in production)
        console.debug('Added to cart:', { product_id: pid, response: result.json || result });
      } else {
        showToast('Could not add to cart', true);
        console.error('Add to cart error (button):', result.error || result.status);
      }

      try {
        el.disabled = false;
      } catch (ignored) {}
    });
  });

  // Small UI effect for non-AJAX fallback (keeps previous visual behaviour)
  document.body.addEventListener('click', function (e) {
    var btn = e.target.closest && e.target.closest('.add-to-cart');
    if (btn && btn.tagName !== 'FORM') {
      try {
        btn.disabled = true;
        setTimeout(function () { try { btn.disabled = false; } catch (e) {} }, 900);
      } catch (ignore) {}
    }
  }, false);
});